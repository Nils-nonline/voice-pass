<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>unbenannt</title>
<meta name="generator" content="Geany 2.0" />
</head>

<body>
	<h1>Hi there!</h1>
	<button id="record">Record audio</button>
	<script type="importmap">
	  {
		"imports": {
		  "socket.io-client": "https://cdn.socket.io/4.8.0/socket.io.esm.min.js"
		}
	  }
	</script>
	<script type="module">
		import { io } from "socket.io-client";
		const socket = io();
		
		if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
			console.log("getUserMedia supported.");
			navigator.mediaDevices
				.getUserMedia({audio: {echoCancellation: true, noiseSuppression: true}})
				
				.then((stream) => {
						success(stream);
					})

				.catch((err) => {
				  console.error(`The following getUserMedia error occurred: ${err}`);
				});
		} else {
			alert("getUserMedia not supported on your browser!");
		}
		var duration = 100
		function array2b64( buffer ) {
			var binary = '';
			var bytes = new Uint8Array( buffer );
			var len = bytes.byteLength;
			for (var i = 0; i < len; i++) {
				binary += String.fromCharCode( bytes[ i ] );
			}
			return window.btoa( binary );
		}

		function success(stream){
			const mediaRecorder = new MediaRecorder(stream);
			var record = document.getElementById("record");
			
			record.onclick = () => {
				if(mediaRecorder.state == "recording"){
					mediaRecorder.stop();
					console.log(mediaRecorder.state);
					console.log("recorder stopped");
					record.style.color = "black";
				}else{
					mediaRecorder.start(duration);
					console.log(mediaRecorder.state);
					console.log("recorder started");
					record.style.color = "red";
				}
			};

			mediaRecorder.ondataavailable = (e) => {
				try{
					var blob = new Blob([e.data], { 'type' : 'audio/wav; codecs=0' });
					blob.arrayBuffer().then((data) => {
						var intArray = data
						console.log(String(intArray));
						socket.emit("audio",{"blob":array2b64(intArray)});
						})
					console.log("worked")
					
					
				}catch(e){
					console.log("wrong")
				}
			  
			};
		}

		socket.on("connect", () => {
		  console.log(socket.connected); // true
		});
		
		
		
	</script>
</body>

</html>
