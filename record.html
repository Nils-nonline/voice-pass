<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>unbenannt</title>
<meta name="generator" content="Geany 2.0" />
<style>
button{
	font-size: 15px;
	display: block;
	padding: 13px;
	border: none;
	border-radius: 15pt;
	color: white;
	background-color: black;
	text-decoration: none;	
}
</style>
</head>

<body>
	<div style="display: flex;justify-content: center;align-items: center; flex-direction:column">
		<h1> Record your new voice pass.</h1><br>
		<button id="record">Record voice pass.</button><br>
	</div>
	<script src = "https://cdn.socket.io/4.0.0/socket.io.min.js">
	 
	</script>
	
	<script>
		const socket = io("http://localhost:1337");
		var index = 0;
		var chunks = [];
		async function convert2DataUrl(blobOrFile){
			let reader = new FileReader()
			reader.readAsDataURL(blobOrFile)
			await new Promise(resolve => reader.onload = function(){ resolve() })
			return reader.result
		}
		
		if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
			console.log("getUserMedia supported.");
			navigator.mediaDevices
				.getUserMedia({audio: {echoCancellation: true, noiseSuppression: true}})
				
				.then((stream) => {
						success(stream);
					})

				.catch((err) => {
				  console.error(`The following getUserMedia error occurred: ${err}`);
				});
		} else {
			alert("getUserMedia not supported on your browser!");
		}
		var duration = 100
		

		function success(stream){
			const mediaRecorder = new MediaRecorder(stream);
			var record = document.getElementById("record");
			
			record.onclick = () => {
				if(mediaRecorder.state == "recording"){
					var blob = new Blob(chunks, { 'type' : 'audio/wav; codecs=0' });
					socket.emit('pass', {"d":blob,"index":index});
					mediaRecorder.stop();
					console.log(mediaRecorder.state);
					console.log("recorder stopped");
					record.style.color = "white";
				}else{
					mediaRecorder.start(duration);
					console.log(mediaRecorder.state);
					console.log("recorder started");
					record.style.color = "red";
				}
			};

			mediaRecorder.ondataavailable = (e) => {
				//try{
					console.log("file")
					chunks.push(e.data)
					//const reader = new FileReader();
					//var data = await convert2DataUrl(blob)
					index++;
				/*}catch(e){
					console.log(e.stack)
				}*/
			  
			};
		}
		
		
		
		socket.on("connect", () => {
		  console.log(socket.connected); // true
		});
		
		
		
	</script>
</body>

</html>
